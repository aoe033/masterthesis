%location/filename: tex/ch2.tex
%author: Anders Ã˜stevik
%Last edited: 03.05.2016
%#######--Chapter 2--#######
%Content:
%	hsmc-to-vldb pcb design
%	

\documentclass[main.tex]{subfiles}

\begin{document}

\chapter{HSMC-to-VLDB PCB design} \label{chap:pcb}

In order for communication and the ability to send and monitor test data, a form of connection between the \gls{fpga} and the \gls{vldb} is required. The \gls{vldb} has twenty additional \acrshort{hdmi} female connectors which connects to the \gls{lvds} transceivers for high-speed communication with the \gls{cru}. The \gls{fpga} board that is used for this thesis has two \gls{hsmc} connectors with port A containing the \gls{lvds} transceivers. In addition to the \gls{lvds} signals, the connection also needs to contain the Radiation-hard optical link, i.e support for SFP fiber-optic cabling.\\

\section{Specification}



\section{Design discussion}

The design discussion and planning of the \gls{pcb} was done together with Ph. D. Arild Velure.\\

The initial plan was to design a \gls{pcb} with a male \gls{sfp}-contact in one end connected with two \gls{hdmi} connectors, one on each side of the \gls{pcb}, making an adapter that can be plugged directly into the \gls{sfp}-connectors on the \gls{sfp}-board with \gls{hdmi} cables to the \gls{vldb}. This design was quickly scratched as there was no loose male \gls{sfp} connectors available on the marked, only female. The design plan was then changed to use only one \gls{pcb} board with female \glspl{sfp}-connectors on one side, wired to \gls{hdmi}-connectors on the other side, acting as a middle joint between the \gls{sfp}-board and the \gls{vldb} with \gls{sfp}- and \gls{hdmi}-cables connecting the three boards together. \\

The end result was a design that could be directly mounted on the \gls{fpga} through the \gls{hsmc} connector. By copying one of the \gls{sfp}-to-\gls{hsmc} connections from the original \gls{sfp}-board design files (the one concerning the \gls{xcvr}-protocol, see \cite{sfp_schem}), we found that we could remove the \gls{sfp}-board completely from the connection chain and eliminate the resulting need for electrical \gls{sfp}-cables. This would also remove the middle joint in the chain, reducing complexity and saving costs. The resulting design was a board connected to the \gls{fpga} via the \gls{hsmc}-connector, with \gls{lvds}-signals running to ten \gls{hdmi} connectors and \gls{xcvr}-signals running to one \gls{sfp}-connector for fiber-optic communication.

\begin{figure}[ht] % H(strictly put HERE > h!)
% h(here), !(force), t(top), b(bottom), p(on extra page)
\includegraphics[width=\linewidth]{../img/HSMC_52_53_hsmcspec}  \\[0.1 cm]
\caption{Male (ASP-122952) and female (ASP-122953) HSMC-connectors. The male type is to be connected at the bottom of the HSMC-to-VLDB \gls{pcb} \cite[Figure 2-1]{altera_hsmc09}.}
\label{fig:hsmc}
\end{figure}

\section{High Speed PCB Design}

When transmitting signals through a conductor at high frequencies, the conductor no longer acts as an ideal wire. The signal voltage stops acting instantaneous across the conducting path, and factors like impedance mismatch and reflections becomes important for the quality of the signal to remain the same through the whole transmission. This section gives a brief explanation of high frequency signal behavior and the compensation methods that was practiced during the design of the \gls{hsmc}-to-\gls{vldb} \gls{pcb}.

\subsection{Transmission lines}

When signal rise/fall times becomes comparable with the propagation delay of the conductor, the signal no longer acts instantaneous. The conductor becomes what is known as a transmission line, with the signals voltage and current acting like waves propagation through the conductor. 
The general rule for determining if a signal is propagating along a transmission line is when the rise/fall time of the signal is less than 1/4 of the signal period, so that the high and low states are recognizable \cite{weste11}.

For an \gls{lvds}-protocol, with signal speeds reaching up to $3.125\ \giga\bit\per\second$, the trace becomes a transmission line if the signal propagation time along the trace is less than 1/4 of the signal period, i.e $80\pico\second$. 

The propagation velocity of a signal is given by:

\begin{equation}
%\[
    v = \frac{c}{\sqrt{\epsilon_r}}
%\]
\end{equation}

, where $\epsilon_r$ is the dielectric constant of the epoxy material FR4, often used as a material to separate the copper layers on the \glspl{pcb}. $\epsilon_r$ has a value of around $4.05$ @ $3\ \giga\hertz$ \cite{polar15}.
A signal thus propagates through the conductor at a velocity of approximately $15\ \milli\meter/\nano\second$ \cite[example 13.7]{weste11}.

Thus, by assuming a constant transmitting frequency of $3.125\ \giga\bit\per\second$, a conductor becomes a transmission line if the length of the conductor stretches longer than $12\ \milli\meter$ between transmitter and receiver. This short length is very difficult to avoid when designing a \gls{pcb} with microstrip traces running from one connector out to eleven other connectors. The traces on the HSMC-to-VLDB \gls{pcb} are therefore considered as transmission lines. 

\subsection{Reflections and characteristic impedance}

Since the signals no longer acts instantaneous, the transmitter can not see what is connected at the receiving end at the time it sends a pulse down the conducting channel. All it sees is the channel impedance, called the characteristic impedance, $Z_0$, of the channel \cite{weste11}.

The type of trace that is used in the \gls{hsmc}-to-\gls{vldb} \gls{pcb} design is called a microstrip, which is when the signal traces run along traces on the outer layers of the \gls{pcb} with the ground plane on the layer underneath. 

    \definecolor{FR4}{HTML}{20B356}
    \definecolor{COPPER}{HTML}{FFA500}

\begin{figure}[ht]

    \centering
    %Microstrip single-ended
    \begin{tikzpicture}
        
      %Ground Plane
      \draw[yslant=0,fill=COPPER,opacity=1] (0,-1.0) rectangle (4,-0.8);  %Front
      \draw[yslant=0.5, fill=COPPER,opacity=1] (4,-2.8) rectangle (6,-3); %Side
      %\draw[yslant=0.5,xslant=-2] (0.4,0.2) rectangle (2.4,-1.8);           %Top

      %FR4 Plane
      \draw[yslant=0.0, fill=FR4,opacity=1] (0,-0.8) rectangle (4,0.2);                %Front
      \draw[yslant=0.5, fill=FR4,opacity=1] (4,-2.8) rectangle (6,-1.8);               %Side
      \draw[yslant=0.5,xslant=-2, fill=FR4!90,opacity=1] (0.4,0.2) rectangle (2.4,-1.8);  %Top

       %Trace
      \draw[yslant=0,fill=COPPER] (1.45,0.2) rectangle (2.45,0.38);                   %Front
      \draw[yslant=0.5,fill=COPPER] (2.44,-0.85) rectangle (4.45,-1.02);            %Side
      \draw[yslant=0.5,xslant=-2, fill=COPPER!80] (0.75,-0.85) rectangle (2.74,-0.35); %Top

      \draw[<->] (0.4,-0.8) -- (0.4,0.2) node [midway,fill=FR4] {h};
      \draw[|<->|] (1.45,-0.2) -- (2.45,-0.2) node [midway,fill=FR4] {w};
    
       \draw[] (-0.4,0.38) -- (1.6,1.38) node [midway, fill=white] {l};

      \draw[|<->|] (1.2,0.195) -- (1.2,0.38) node [left] {t};

    \end{tikzpicture}
    \caption{Cross-section of a single-ended microstrip with the copper trace on top, followed by a dielectric layer and a ground plane. h is the thickness of the dielectric, t is the copper thickness, l is the microstrip length, and w is the copper width.}
    \label{fig:microstrip}

\end{figure}

A microstrip has a characteristic impedance that is given by:

\begin{equation}
    Z_0 = \frac{60}{\sqrt{0.475\epsilon_r + 0.67}} \times \ln{\frac{4h}{0.67(0.8w + t)}}
\end{equation}

, where $\epsilon_r$ is the dielectric constant, h is the height of the microstrip seen from the ground plane, i.e the thickness of the FR4 layer, w is the width of the microstrip, and t is the thickness of the copper \cite{weste11}.

It is important to match the impedance of the trace to that of the load impedance at the receiving end, or vice versa. With these being different, the energy of the signal cannot be fully absorbed at the receiving end, resulting in a partly reflection of the signal wave back to the transmitter. The ratio of the wave reflected back is given by:

\begin{equation}
\Gamma = \frac{Z_L - Z_0}{Z_L + Z_0}	
\end{equation}

, where $Z_L$ is the load impedance and $Z_0$ is the characteristic impedance.

Ideally the $Z_L$ and $Z_0$ should be equal to avoid reflections. Impedance mismatch can cause waste of signal energy and interference with other signal pulses being transmitted through the channel \cite{weste11}. \\

When looking at the datasheet for cables with differential signals, such as HDMI-cables, it is often supplied a differential impedance between the cables instead of a characteristic impedance for each cable. Knowing the characteristic impedance, it is possible to calculate the corresponding differential impedance between two microstrip traces (or vice versa):

\begin{equation}
    Z_{diff} = 2 \times Z_0 [1 - 0.48 e^{(-0.96 \times \frac{s}{h})}]
\end{equation}

, where $Z_0$ is the characteristic impedance of the individual microstrips (assuming they are equal and have the same length), s is the spacing between the microstrips and h is the same as in the equation above \cite{douglas98}.

\begin{figure}[h]
%Microstrip differential
\centering
\begin{tikzpicture}
    
  %Ground Plane
  \draw[yslant=0,fill=COPPER,opacity=1] (0,-1.0) rectangle (4,-0.8);  %Front
  \draw[yslant=0.5, fill=COPPER,opacity=1] (4,-2.8) rectangle (6,-3); %Side

  %FR4 Plane
  \draw[yslant=0.0, fill=FR4,opacity=1] (0,-0.8) rectangle (4,0.2);                %Front
  \draw[yslant=0.5, fill=FR4,opacity=1] (4,-2.8) rectangle (6,-1.8);               %Side
  \draw[yslant=0.5,xslant=-2, fill=FR4!90,opacity=1] (0.4,0.2) rectangle (2.4,-1.8);  %Top

  %Trace#1
  \draw[yslant=0,fill=COPPER] (0.45,0.2) rectangle (1.45,0.38);                   %Front
  \draw[yslant=0.5,fill=COPPER] (1.45,-0.35) rectangle (3.45,-0.53);            %Side
  \draw[yslant=0.5,xslant=-2, fill=COPPER!80] (0.75,0.15) rectangle (2.74,-0.35); %Top

  %Trace#2
  \draw[yslant=0,fill=COPPER] (2.45,0.2) rectangle (3.45,0.38);                   %Front
  \draw[yslant=0.5,fill=COPPER] (3.45,-1.35) rectangle (5.45,-1.53);            %Side
 \draw[yslant=0.5,xslant=-2, fill=COPPER!80] (0.75,-0.85) rectangle (2.74,-1.35); %Top

  \draw[<->] (0.25,-0.8) -- (0.25,0.2) node [midway,fill=FR4] {h};

  \draw[|<->|] (0.45,-0.2) -- (1.45,-0.2) node [midway,fill=FR4] {w};
  \draw[<->] (1.45,-0.2) -- (2.45,-0.2) node [midway,fill=FR4] {s};
  \draw[|<->|] (2.45,-0.2) -- (3.45,-0.2) node [midway,fill=FR4] {w};
  
  \draw[|<->|] (2.1,0.19) -- (2.1,0.38) node [right] {t};
  
  \draw[] (-0.4,0.38) -- (1.6,1.38) node [midway, fill=white] {l};

\end{tikzpicture}
   \caption{Cross-section of a corresponding differential microstrip. s is the spacing between the strips.}
    \label{fig:diffstrip}
\end{figure}

\subsection{Routing}

As mentioned in section~\ref{subsec:diffsig}, differential signals have noise advantages over single ended signals. This is the case only if the pairs have \textit{equal} path lengths and the individual wires in each pair are routed as close to one another as possible. In addition, to keep crosstalk to its minimum, individual pairs has to be routed a distance away from other wires (In reality, this only becomes a problem when dealing with wiring in the micro-scale domain). Twisting the individual wires in each pair to some extent will also contribute to common noise rejection \cite{weste11}.
This was taken into consideration when routing the \gls{pcb}. 

The individual wires in each pair was kept as close as possible, with a space constraint according to the required differential impedance $Z_{diff}$ of approximately $100\ \ohm$ (See equation \ref{eq:zdiff}). When routing, twisting the wires (where possible) was achieved by purposely making the wires overlap at the viases). After routing the wires, attempts were made to separate the pairs a distance from one another, but this was not a critical stage.

\section{PCB design parameters}

To avoid signal reflections, the \gls{pcb} needed a characteristic impedance matching that of the cables and termination, in this case a single wire impedance of $50\ \ohm$, and a differential impedance of $100\ \ohm$. This was derived from the fact that the \gls{hdmi}-cables were specified to have a differential impedance of approximately $100\ \ohm$, which is also the case of the termination resistance at the receiving end (this must be manually set for the \gls{fpga} transceivers).

The \gls{pcb} was chosen to be four layers, with signals running on the top and bottom copper layers, and the two middle planes for voltages and ground respectively.

For thicknesses of the different \gls{pcb} copper layers and the FR4 in between, Elprint has a set of predefined \textit{stack-ups} available in Macaos. It is possible to define custom stack-ups as well, but this will result in a more costly \gls{pcb}. The $4036$ pre-defined stack-up has a copper thickness of $18\ \micro\meter$ on the two outer layers following an FR4 thickness of $65\ \micro\meter$ between the outer layers and the power planes, with the power planes having a thickness of $35\ \micro\meter$. Between the power planes is another FR4 layer with a thickness of $1.4 \milli\meter$ making the total \gls{pcb} thickness of a standard $1.6 \milli\meter$. With a mircostrip width of $100\ \micro\meter$, the formula for characteristic impedance yields:

\begin{equation}
Z_0 = \frac{60}{\sqrt{(0.475 \times 4.05) + 0.67}}\ln{3.96}
\end{equation}

, which gives a characteristic impedance $Z_0$ of $51.3\ \ohm$ @ $3\ \giga\hertz$. 

With a $300\ \micro\meter$ spacing between the differential traces, the formula for differential impedance yields:

\begin{equation}
    Z_{diff} = 2 \times 51.3\ \ohm [1 - 0.48 e^{(-0.96 \times \frac{300}{65})}]
  \label{eq:zdiff}
\end{equation}

, which gives a differential impedance $Z_{diff}$ of $102\ \ohm$ @ $3\ \giga\hertz$.\\

Orcad PCB Editor has a built-in impedance calculator which yields similar results as shown above:

\begin{table} [H]
\begin{center}
    \begin{tabular}{| l | l | l | l | l | l | l | l | l |}
    \hline
     & Layer & Type & t $[\micro\meter]$ & $\epsilon_r$ & w $[\micro\meter]$  & $Z_0 [\ohm]$ & Spacing $[\micro\meter]$  & $Z_{diff} [\ohm]$ \\ 
     \hline
    1 	  & Surface & Air 		 & 		& 1 	 & 	   & 					& 	  & \\ \hline
    2 	  & Top 	& Conductor  & 18 	&        & 100 & $51.3$             & 300 & 102\\ \hline
    3 	  &  		& Dielectric & 65 	& $4.05$ & 	   & 					& 	  & \\ \hline
    4 	  & Voltage & Plane 	 & 35 	&        & 	   & 					& 	  & \\ \hline
    5 	  &  		& Dielectric & 1400 & $4.05$ & 	   &					&	  & \\ \hline
    6 	  & Gnd 	& Plane 	 & 35 	&        & 	   & 					& 	  & \\ \hline
    7 	  &  		& Dielectric & 65 	& $4.05$ &     & 					& 	  & \\ \hline
    8 	  & Bottom 	& Conductor  & 18 	&        & 100 & $51.3$             & 300 & 102\\ \hline
    9 	  & Surface & Air 		 & 	  	& 1 	 & 	   & 					& 	  & \\ \hline
    \end{tabular}
     \caption{The layers of the PCB and their traits, where t is the layer thickness and w is the width of the trace. The PCB has an overall thickness of $1.6\ \milli\meter$}
	\label{tab:Xsect1}
\end{center}
\end{table}

\section{Further specification and ordering}

The \gls{pcb} schematic was designed using \textit{Orcad Capture CIS} and the layout using \textit{Orcad \gls{pcb} Editor}, with design parameters meeting \textit{Elprint's} capabilities \cite{elprint15}. The \gls{pcb} layout was then exported into \textit{Gerber-files} and imported into \textit{Macaos} for further manufacture specification and validation. The \gls{pcb} was then ordered from Elprint.% and arrived in office 21/12/2015.

\section{Soldering process}

All the components on the \gls{pcb} was soldered by hand, with the exception of the ground pads underneath the \gls{hsmc}, which had to be soldered using solder paste and a solder oven.

\subsection{Martin Rework Station}

The \gls{hsmc}-connector has several ground pads underneath the connector itself, making it impossible to reach when soldering by hand. The solution to this was to apply solder paste on the pads with the help the Martin Rework Station dispenser module that was available in the lab. The dispenser module forces the solder paste out of the syringe using pressurized air. By pressing a foot pedal connected to the dispenser, you apply a controlled air pulse that pushes on the piston of the solder paste syringe. The force of the air pulse can be adjusted using the dispenser \gls{gui}. For the ground pads, a force of $2.50 ccm$ was suitable.  

\subsection{Solder Oven}

The oven was set to a warm-up temperature of 150  for 60 seconds, and then a climb temperature of max 220 with a climb-time of 120 seconds.

\section{PCB faults and compensations}

After receiving the \glspl{pcb}, further inspection revealed that all viases had missing solder mask. This exposes the metal of the vias to the surface of the \gls{pcb} and can possibly cause connection shorts between the viases and the pads and/or metallic casings when soldering. The reason for the viases not to have a solder mask is because it was missing in the pad file. A solution to fix this in a future \gls{pcb} print would obviously be to include a solder mask in the pad file.
With the current \gls{pcb} print, however, a temporary solution would be to apply thin \textit{kapton tape} where most critical. \\

The exposed viases was later shown not to be as critical as first thought, due to the following points: \\
\begin{itemize}

\item The viases that are exposed underneath the \gls{hdmi} casings are in fact connected to ground, making the possible shorts between the viases and the already ground connected casing not a critical problem. \\

\item The exposed viases underneath the \gls{hsmc}-connector could potentially connect to the ground pads when applying solder paste to the pads. This was avoided by carefully applying  a thin line of solder paste in the middle of the ground pads. This prevented the solder paste to float over to the neighboring viases when melting it in the oven. A possible drawback to this would be bad connection between the ground pads and the \gls{hsmc}-connector, but a quick check using a multimeter proved that the \gls{hsmc} was indeed connected to all the ground pads.\\
\end{itemize}

In fact, when testing the \gls{pcb}, the exposure of viases on the transmitter and receiver lines revealed to be quite useful connection points when using an oscilloscope to measure the signal integrity of the signals. Due to the lack of extra added connection points, measuring signals at the \gls{pcb} viases became the most convenient way of directly measuring the transmitted and received signals (see subsection below). A lesson until next \gls{pcb}-prototype is to include easily accessible probe connection points on lines that are relevant for oscilloscope measurement.\\

On the current version of the \gls{pcb}, some of the receiver lines includes a $10~\kilo\ohm$ pull-up resistor (R91, R92, R95, R96, R97, R99, R100 and R101 in the schematic). The reason why these are included could possibly be due to a misinterpretation of the \gls{sfp}-schematic in which the design of the \gls{pcb} was based on. This is concluded because two of the pull-up resistors (R100 and R101 in the schematic) are connected to receiver signals that are only used in the \gls{sfp}-design, but not in this design. The pull-up resistors are therefore not included, and the lines are left open.

\begin{figure}[H] % H(strictly put HERE > h!)
% h(here), !(force), t(top), b(bottom), p(on extra page)
\includegraphics[width = 7 cm]{../img/pullups}  \\[0.1 cm]
\caption{Pull-up resistors on some of the receiver lines.}
\label{fig:pullups}
\end{figure}

Later discussions with Arild revealed that the transmitters on the GBT-VLDB did not have voltage pull-ups, which is necessary for the \gls{lvds}-signals. The current \gls{pcb} will therefore not work properly with the GBT-VLDB card. Later versions of the \gls{pcb} should therefore contain resistors pulling up to $1.25 \volt$ on the receiver lines in order for it to work.

\chapter{Testing and verification of the HDMI daughter card}
To verify a working \gls{pcb}, the \gls{hdmi} daughter card underwent a series of tests. The sections below summarizes these tests. 

\section{Connectivity test}

\textit{Since all the components on the \gls{pcb} was hand soldered (with the exception of the ground pads underneath the \gls{hsmc} contact), it was particularly important to check for accidental shorts between pins and/or pads.}

\subsection{Purpose of test}

\begin{itemize}
\item Verify that there are no shorts between the pins and/or pads of the \gls{pcb}. 
\item Check for current draw to confirm that there are no short on the power-lines.
\end{itemize}

\subsection{Experimental setup}

The setup involves the use of a multimeter to go through all pins and check for connection faults according to the schematic. After all shorts have been eliminated, the \gls{pcb} is to be connected to an external power supply to verify current-draw. 

\subsection{Results}
 Using a multimeter, all connections were checked and verified that there were no shorts (Some pins on the \gls{hsmc} were indeed shorted and had to be re-soldered). The \gls{pcb} was then connected to an external power supply and it was verified that the current draw, with all \gls{hdmi}-connections left open, were no more than the current drawn from the power-\acrshort{led}, i.e $18~\milli\ampere$. \\

To confirm connectivity and that there were no further connecting shorts between the pads and/or pins, a simple test-circuit was written in Quartus. Beginning with the transmit-signals: all the relevant \gls{lvds} transmit-signals that are physically connected to the \gls{hsmc} (port A) connector of the \gls{fpga} were connected to a given clock signal. The \gls{pcb} was then connected to the \gls{fpga} board, and the \gls{hdmi} connectors were probed with the help of an oscilloscope and verified that there was an output signal on every \gls{hdmi}-transmitter. 

The \gls{pcb} is now ready for connection with the host \gls{fpga} for further testing of the transmitter and receiver signals. 

\section{External loop-back test for the fiber-optic connector}

\textit{To verify that the \gls{hdmi} daughter card SFP-connector for fiber-optic communication is working correctly, an external loop-back test was conducted.}

\subsection{Purpose of test}
\begin{itemize}

\item Test the dedicated SFP-connector on the \gls{hdmi}-daughter card for fiber-optic communication and see that it is capable of sending and receiving information at speeds up to the \gls{gbt}-standard of $4.8 \giga\bit\per\second$. 
\end{itemize}

\subsection{Experimental setup}
A fiber-optic cable connected from the transmitter to the receiver using a fiber-module, forming an external loop through the cable, was connected to the SFP-connector of the \gls{hdmi}-daughter card \gls{pcb}. Using the \gls{gbt} Quartus-example together with the In-system-source-and-probe editor and SignalTap II, it was possible to connect the transmitter to a internal counter that counted with increments of one. SignalTap II was then used to monitor and verify that the receiver line received the same incremented counter as the transmitter sent out.

\subsection{Results}


\section{External loop-back test for the HDMI connectors}

\subsection{Purpose of tests}

\begin{itemize}
\item Measure the quality of the signal at different frequencies up to $300~\mega\hertz$ and see how reflections affects the signal.
\item Measure crosstalk between neighboring signal paths.
\item Create a test environment using Quartus II in conjunction with SignalTap II to:
\begin{itemize}
  \item See if it is possible to sample the received signals at different frequencies up to $300~\mega\hertz$.
  \item Investigate bit-error rate at different frequencies up to $300~\mega\hertz$.
\end{itemize}
\end{itemize}

\subsection{Experimental setup}

Each \gls{hdmi}-connector has at least one transmitter- and receiver line. To simulate signal transmission over a distance, a \gls{hdmi} cable was cut in half and the transmit- and receive lines were soldered together, creating an external loop-back. A pseudo-random generated bit-signal would travel out via one of the transmitters of the \gls{fpga}, out through a \gls{hdmi}-connector, following the cable back into the same \gls{hdmi}-connector into the receiver input.

\subsection{Results}

The following table sums up the cable-length and theoretical travel time versus the measured delay between the transmitted and received signal.

\section{Conclusion and discussions}

The measurement setup has a lot to say when it comes to measur


\end{document}